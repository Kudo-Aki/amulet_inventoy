<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ãƒã‚¹ã‚¿ç·¨é›†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #8B0000 0%, #B22222 100%);
            color: white;
            padding: 16px;
            text-align: center;
        }
        .header h1 {
            font-size: 1.5rem;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #8B0000;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #8B0000;
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #1565C0;
        }
        .warning-box {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #e65100;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f9f9f9;
            font-weight: 600;
            color: #666;
        }
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        input:focus {
            outline: none;
            border-color: #8B0000;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .btn-primary {
            background: #8B0000;
            color: white;
        }
        .btn-primary:hover {
            background: #6B0000;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        .btn-info {
            background: #2196F3;
            color: white;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        .add-form {
            display: grid;
            grid-template-columns: 1fr 1fr 100px auto;
            gap: 10px;
            align-items: end;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }
        .add-form label {
            display: block;
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 4px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            z-index: 1000;
            display: none;
        }
        .toast.success { background: #4CAF50; }
        .toast.error { background: #f44336; }
        .toast.show { display: block; }
        .actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .action-group {
            margin-bottom: 16px;
        }
        .action-group h3 {
            font-size: 1rem;
            color: #666;
            margin-bottom: 8px;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #8B0000;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        @media (max-width: 600px) {
            .add-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>âš™ï¸ å•†å“ãƒã‚¹ã‚¿ç·¨é›†</h1>
    </div>

    <div class="container">
        <div class="section">
            <h2>ç¾åœ¨ã®å•†å“ãƒã‚¹ã‚¿</h2>
            <div class="info-box">
                å•†å“ã‚³ãƒ¼ãƒ‰ã¯è‹±å¤§æ–‡å­—ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚å…¥æ•°ã¯1ç®±ã‚ãŸã‚Šã®ãŠå®ˆã‚Šã®å€‹æ•°ã§ã™ã€‚
            </div>
            <table id="master-table">
                <thead>
                    <tr>
                        <th>å•†å“ã‚³ãƒ¼ãƒ‰</th>
                        <th>å•†å“å</th>
                        <th>å…¥æ•°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="master-tbody">
                </tbody>
            </table>

            <div class="add-form">
                <div>
                    <label>å•†å“ã‚³ãƒ¼ãƒ‰</label>
                    <input type="text" id="new-code" placeholder="ä¾‹: OMAMORI">
                </div>
                <div>
                    <label>å•†å“å</label>
                    <input type="text" id="new-name" placeholder="ä¾‹: æ–°å•†å“å®ˆã‚Š">
                </div>
                <div>
                    <label>å…¥æ•°</label>
                    <input type="number" id="new-quantity" placeholder="50" min="1">
                </div>
                <div>
                    <button class="btn btn-success" onclick="addProduct()">è¿½åŠ </button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ãƒã‚¹ã‚¿ã®ä¿å­˜ãƒ»å…±æœ‰</h2>
            <div class="warning-box">
                âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ãƒã‚¹ã‚¿ãŒæ¶ˆãˆã¾ã™ã€‚<br>
                å¿…ãšã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚
            </div>
            
            <div class="action-group">
                <h3>ğŸ“± ã‚¹ãƒãƒ›é–“ã§ãƒã‚¹ã‚¿ã‚’å…±æœ‰ã™ã‚‹</h3>
                <button class="btn btn-info" onclick="exportMaster()">ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜</button>
                <div class="file-input-wrapper">
                    <button class="btn btn-info">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
                    <input type="file" id="import-file" accept=".json" onchange="importMaster(event)">
                </div>
                <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                    ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯LINEãƒ»AirDropãƒ»ãƒ¡ãƒ¼ãƒ«ã§ä»–ã®ã‚¹ãƒãƒ›ã«é€ã‚Œã¾ã™
                </p>
            </div>

            <div class="action-group">
                <h3>ğŸ’¾ ã“ã®ã‚¹ãƒãƒ›ã«ä¿å­˜</h3>
                <button class="btn btn-primary" onclick="saveMaster()">ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</button>
                <button class="btn btn-danger" onclick="resetMaster()">ğŸ”„ åˆæœŸçŠ¶æ…‹ã«æˆ»ã™</button>
            </div>

            <div class="action-group">
                <h3>ğŸ”§ é–‹ç™ºè€…å‘ã‘</h3>
                <button class="btn btn-secondary" onclick="exportMasterAsJS()">ğŸ“¤ app.jsç”¨ã‚³ãƒ¼ãƒ‰å‡ºåŠ›</button>
                <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                    GitHub Pagesã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¹ã‚¿ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã«ä½¿ç”¨
                </p>
            </div>
        </div>

        <a href="index.html" class="back-link">â† ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¹ã‚¿
        const DEFAULT_MASTER = {
            'HEALTH': { name: 'å¥åº·å®ˆã‚Š', quantity: 50 },
            'MONEY': { name: 'é‡‘é‹å®ˆã‚Š', quantity: 100 },
            'LOVE': { name: 'ç¸çµã³å®ˆã‚Š', quantity: 80 },
            'TRAFFIC': { name: 'äº¤é€šå®‰å…¨å®ˆã‚Š', quantity: 60 },
            'STUDY': { name: 'å­¦æ¥­æˆå°±å®ˆã‚Š', quantity: 70 },
            'FAMILY': { name: 'å®¶å†…å®‰å…¨å®ˆã‚Š', quantity: 50 },
            'BUSINESS': { name: 'å•†å£²ç¹ç››å®ˆã‚Š', quantity: 60 },
            'CHILD': { name: 'å­æˆã‘å®ˆã‚Š', quantity: 40 },
            'RECOVERY': { name: 'ç—…æ°—å¹³ç™’å®ˆã‚Š', quantity: 50 },
            'LUCK': { name: 'é–‹é‹å®ˆã‚Š', quantity: 80 }
        };

        let master = {};

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadMaster();
            renderTable();
        });

        // ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿
        function loadMaster() {
            const stored = localStorage.getItem('omamori_master');
            if (stored) {
                try {
                    master = JSON.parse(stored);
                } catch (e) {
                    master = { ...DEFAULT_MASTER };
                }
            } else {
                master = { ...DEFAULT_MASTER };
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderTable() {
            const tbody = document.getElementById('master-tbody');
            tbody.innerHTML = '';

            Object.keys(master).sort().forEach(code => {
                const product = master[code];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${code}" data-original="${code}" onchange="updateCode(this)"></td>
                    <td><input type="text" value="${product.name}" onchange="updateName('${code}', this.value)"></td>
                    <td><input type="number" value="${product.quantity}" min="1" onchange="updateQuantity('${code}', this.value)"></td>
                    <td><button class="btn btn-danger btn-small" onclick="deleteProduct('${code}')">å‰Šé™¤</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // å•†å“ã‚³ãƒ¼ãƒ‰æ›´æ–°
        function updateCode(input) {
            const oldCode = input.dataset.original;
            let newCode = input.value.toUpperCase().replace(/[^A-Z]/g, '');
            input.value = newCode;

            if (newCode && newCode !== oldCode) {
                if (master[newCode]) {
                    showToast('ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
                    input.value = oldCode;
                    return;
                }
                master[newCode] = master[oldCode];
                delete master[oldCode];
                input.dataset.original = newCode;
                showToast('å•†å“ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            }
        }

        // å•†å“åæ›´æ–°
        function updateName(code, name) {
            if (master[code]) {
                master[code].name = name;
                showToast('å•†å“åã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            }
        }

        // å…¥æ•°æ›´æ–°
        function updateQuantity(code, quantity) {
            if (master[code]) {
                master[code].quantity = parseInt(quantity) || 1;
                showToast('å…¥æ•°ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            }
        }

        // å•†å“è¿½åŠ 
        function addProduct() {
            let code = document.getElementById('new-code').value.toUpperCase().replace(/[^A-Z]/g, '');
            const name = document.getElementById('new-name').value.trim();
            const quantity = parseInt(document.getElementById('new-quantity').value) || 50;

            if (!code) {
                showToast('å•†å“ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!name) {
                showToast('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (master[code]) {
                showToast('ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
                return;
            }

            master[code] = { name, quantity };
            renderTable();

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById('new-code').value = '';
            document.getElementById('new-name').value = '';
            document.getElementById('new-quantity').value = '';

            showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        // å•†å“å‰Šé™¤
        function deleteProduct(code) {
            if (confirm(`ã€Œ${master[code].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete master[code];
                renderTable();
                showToast('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜
        function saveMaster() {
            localStorage.setItem('omamori_master', JSON.stringify(master));
            showToast('ãƒã‚¹ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼‰
        function exportMaster() {
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                master: master
            };
            const json = JSON.stringify(exportData, null, 2);
            const filename = `omamori_master_${new Date().toISOString().slice(0,10)}.json`;
            downloadFile(json, filename, 'application/json');
            showToast('ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
        function importMaster(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // æ–°å½¢å¼ï¼ˆversionä»˜ãï¼‰ã¨æ—§å½¢å¼ã®ä¸¡æ–¹ã«å¯¾å¿œ
                    let importedMaster;
                    if (data.master && typeof data.master === 'object') {
                        importedMaster = data.master;
                    } else if (typeof data === 'object' && !data.version) {
                        importedMaster = data;
                    } else {
                        throw new Error('Invalid format');
                    }

                    // å½¢å¼ãƒã‚§ãƒƒã‚¯
                    const keys = Object.keys(importedMaster);
                    if (keys.length === 0) {
                        throw new Error('Empty master');
                    }

                    // å„å•†å“ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
                    for (const code of keys) {
                        const product = importedMaster[code];
                        if (!product.name || typeof product.quantity !== 'number') {
                            throw new Error('Invalid product format');
                        }
                    }

                    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                    if (confirm(`${keys.length}ä»¶ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚\nç¾åœ¨ã®ãƒã‚¹ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                        master = importedMaster;
                        renderTable();
                        saveMaster(); // è‡ªå‹•ä¿å­˜
                        showToast(`${keys.length}ä»¶ã®å•†å“ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                    }
                } catch (error) {
                    showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
            event.target.value = '';
        }

        // app.jsç”¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportMasterAsJS() {
            let js = 'const DEFAULT_MASTER = {\n';
            Object.keys(master).sort().forEach(code => {
                const p = master[code];
                js += `    '${code}': { name: '${p.name}', quantity: ${p.quantity} },\n`;
            });
            js += '};\n';
            downloadFile(js, 'master_for_appjs.txt', 'text/plain');
            showToast('app.jsç”¨ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ', 'success');
        }

        // åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        function resetMaster() {
            if (confirm('ãƒã‚¹ã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nè¿½åŠ ã—ãŸå•†å“ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                master = { ...DEFAULT_MASTER };
                renderTable();
                showToast('åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => {
                toast.className = 'toast';
            }, 2000);
        }
    </script>
</body>
</html>
